<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>EPUB 英中對齊工具</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- JSZip 必須先載入 -->
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/epubjs/dist/epub.min.js"></script>

  <style>
    .editor { display: flex; gap: 20px; }
    .column { flex: 1; border: 1px solid #ccc; padding: 10px; border-radius: 6px; background: #f8f9fa; min-height: 200px; }
    .card { padding: 8px; border: 1px solid #ddd; border-radius: 6px; background: #fff; margin-bottom: 10px; }
    .card div[contenteditable] { min-height: 120px; outline: none; }
  </style>
</head>
<body class="p-4">

<h2 class="mb-3">EPUB 英中對齊工具</h2>

<div class="mb-3">
  <label class="form-label">上傳英文 EPUB</label>
  <input type="file" id="uploadEn" class="form-control mb-2" accept=".epub">
  <label class="form-label">上傳中文 EPUB</label>
  <input type="file" id="uploadZh" class="form-control" accept=".epub">
</div>

<div class="editor my-4">
  <div class="column en-col" id="enCol">
    <h5 class="mb-3">英文</h5>
  </div>
  <div class="column zh-col" id="zhCol">
    <h5 class="mb-3">中文</h5>
  </div>
</div>

<div class="mt-4">
  <label class="form-label">起始序號</label>
  <input type="number" id="startIndex" class="form-control w-25 mb-3" value="0">
  <button class="btn btn-primary" id="saveBtn">產生檔案清單</button>
</div>

<script>
  // 建立卡片
  function createCard(lang, htmlContent) {
    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `
      <div contenteditable="true">${htmlContent}</div>
      <button class="btn btn-sm btn-danger mt-2 delete-btn" data-lang="${lang}">
        刪除 ${lang === "en" ? "EN" : "中文"}
      </button>
    `;
    return card;
  }

  // 刪除卡片
  document.addEventListener("click", (e) => {
    if (e.target.classList.contains("delete-btn")) {
      const card = e.target.closest(".card");
      if (card) card.remove();
    }
  });

  // 拖曳初始化
  new Sortable(document.getElementById("enCol"), { animation: 150 });
  new Sortable(document.getElementById("zhCol"), { animation: 150 });

  // 上傳圖片到後端
  async function uploadImage(file) {
    const formData = new FormData();
    formData.append("image", file);
    // TODO: 替換為你後端上傳 URL
    const response = await fetch("/upload-image", { method: "POST", body: formData });
    const data = await response.json();
    return data.url; // 後端回傳的圖片 URL
  }

  // 替換 HTML 內圖片
  async function processImages(doc) {
    const imgs = doc.querySelectorAll("img");
    for (const img of imgs) {
      if (img.src.startsWith("data:")) continue; // 已經是 base64
      try {
        const res = await fetch(img.src);
        const blob = await res.blob();
        const uploadedUrl = await uploadImage(blob);
        img.src = uploadedUrl;
      } catch(e) {
        console.error("圖片上傳失敗:", e);
      }
    }
  }

  // 解析 EPUB 並建立卡片
  async function parseEpub(file, targetCol, lang) {
    const book = ePub(file);
    await book.ready;
    for (const section of book.sections) {
      const htmlDoc = await section.render();
      await processImages(htmlDoc.document);
      targetCol.appendChild(createCard(lang, htmlDoc.document.body.innerHTML));
    }
  }

  // 上傳 EPUB 事件
  document.getElementById("uploadEn").addEventListener("change", async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const enCol = document.getElementById("enCol");
    enCol.innerHTML = "<h5 class='mb-3'>英文</h5>";
    await parseEpub(file, enCol, "en");
  });

  document.getElementById("uploadZh").addEventListener("change", async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const zhCol = document.getElementById("zhCol");
    zhCol.innerHTML = "<h5 class='mb-3'>中文</h5>";
    await parseEpub(file, zhCol, "zh");
  });

  // 產生檔案清單
  document.getElementById("saveBtn").addEventListener("click", () => {
    const startIndex = parseInt(document.getElementById("startIndex").value) || 0;
    const enCards = [...document.querySelectorAll("#enCol .card div[contenteditable]")];
    const zhCards = [...document.querySelectorAll("#zhCol .card div[contenteditable]")];

    const maxCount = Math.max(enCards.length, zhCards.length) + startIndex;
    const padLength = maxCount > 99 ? 3 : 2;

    const enFiles = enCards.map((c, i) => ({
      name: `en-${String(i + startIndex).padStart(padLength,"0")}.txt`,
      content: c.innerHTML
    }));
    const zhFiles = zhCards.map((c, i) => ({
      name: `zh-${String(i + startIndex).padStart(padLength,"0")}.txt`,
      content: c.innerHTML
    }));

    console.log("English files:", enFiles);
    console.log("Chinese files:", zhFiles);
    alert("檔案清單已產生，請查看 console.log，之後可接 GitHub API 上傳。");
  });
</script>
</body>
</html>
