<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>EPUB 英中對齊工具</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/epubjs/dist/epub.min.js"></script>
  <style>
    .editor { display: flex; gap: 20px; }
    .column { flex: 1; border: 1px solid #ccc; padding: 10px; border-radius: 6px; background: #f8f9fa; }
    .card { padding: 8px; border: 1px solid #ddd; border-radius: 6px; background: #fff; margin-bottom: 10px; }
    .card div[contenteditable] { min-height: 120px; outline: none; }
  </style>
</head>
<body class="p-4">

  <h2 class="mb-3">EPUB 英中對齊工具</h2>

  <!-- 上傳區 -->
  <div class="mb-3">
    <label class="form-label">上傳英文 EPUB</label>
    <input type="file" id="uploadEn" class="form-control mb-2" accept=".epub">
    <label class="form-label">上傳中文 EPUB</label>
    <input type="file" id="uploadZh" class="form-control" accept=".epub">
  </div>

  <!-- 編輯區 -->
  <div class="editor my-4">
    <div class="column en-col" id="enCol">
      <h5 class="mb-3">英文</h5>
    </div>
    <div class="column zh-col" id="zhCol">
      <h5 class="mb-3">中文</h5>
    </div>
  </div>

  <!-- 起始序號 + 上傳 -->
  <div class="mt-4">
    <label class="form-label">起始序號</label>
    <input type="number" id="startIndex" class="form-control w-25 mb-3" value="0">
    <button class="btn btn-primary" id="saveBtn">產生檔案清單</button>
  </div>

  <script>
    // 建立卡片
    function createCard(lang, text) {
      const card = document.createElement("div");
      card.className = "card";
      card.innerHTML = `
        <div contenteditable="true">${text}</div>
        <button class="btn btn-sm btn-danger mt-2 delete-btn" data-lang="${lang}">
          刪除 ${lang === "en" ? "EN" : "中文"}
        </button>
      `;
      return card;
    }

    // 刪除邏輯
    document.addEventListener("click", (e) => {
      if (e.target.classList.contains("delete-btn")) {
        const card = e.target.closest(".card");
        if (card) card.remove();
      }
    });

    // 初始化拖曳
    new Sortable(document.getElementById("enCol"), { animation: 150 });
    new Sortable(document.getElementById("zhCol"), { animation: 150 });

    // 解析 EPUB 並加入卡片
    // async function parseEpub(file, targetCol, lang) {
    //   const book = ePub(file);
    //   const rendition = book.renderTo(document.createElement("div"));
    //   const toc = await book.loaded.navigation;

    //   // 依章節順序載入
    //   for (const item of toc.toc) {
    //     const section = await book.load(item.href);
    //     const html = new TextDecoder().decode(section);
    //     // 簡單取 <body> 裡的內容
    //     const match = html.match(/<body[^>]*>([\s\S]*?)<\/body>/i);
    //     const bodyContent = match ? match[1] : html;
    //     targetCol.appendChild(createCard(lang, bodyContent));
    //   }
    // }

    async function parseEpub(file, targetCol, lang) {
      const book = ePub(file);
      const toc = await book.loaded.navigation;

      // 依章節順序載入
      for (const item of toc.toc) {
        const section = await book.section(item.href).render(); // epub.js 0.3.x+
        // 取得 HTML 內容
        const bodyContent = section.document.body.innerHTML;
        targetCol.appendChild(createCard(lang, bodyContent));
      }
    }


    // 上傳英文 EPUB
    document.getElementById("uploadEn").addEventListener("change", async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const enCol = document.getElementById("enCol");
      enCol.innerHTML = "<h5 class='mb-3'>英文</h5>";
      await parseEpub(file, enCol, "en");
    });

    // 上傳中文 EPUB
    document.getElementById("uploadZh").addEventListener("change", async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const zhCol = document.getElementById("zhCol");
      zhCol.innerHTML = "<h5 class='mb-3'>中文</h5>";
      await parseEpub(file, zhCol, "zh");
    });

    // 產生檔案清單
    document.getElementById("saveBtn").addEventListener("click", () => {
      const startIndex = parseInt(document.getElementById("startIndex").value) || 0;
      const enCards = [...document.querySelectorAll("#enCol .card div[contenteditable]")];
      const zhCards = [...document.querySelectorAll("#zhCol .card div[contenteditable]")];

      // 決定檔名格式
      const maxCount = Math.max(enCards.length, zhCards.length) + startIndex;
      const padLength = maxCount > 99 ? 3 : 2;

      const enFiles = enCards.map((c, i) => ({
        name: `en-${String(i + startIndex).padStart(padLength, "0")}.txt`,
        content: c.innerHTML
      }));
      const zhFiles = zhCards.map((c, i) => ({
        name: `zh-${String(i + startIndex).padStart(padLength, "0")}.txt`,
        content: c.innerHTML
      }));

      console.log("English files:", enFiles);
      console.log("Chinese files:", zhFiles);
      alert("檔案清單已產生（請開 console 查看），之後可接 GitHub API 上傳。");
    });
  </script>
</body>
</html>
