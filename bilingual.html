<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Bilingual EPUB Chapter Editor</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<style>
  .editor { display: flex; gap: 20px; }
  .column { flex:1; border:1px solid #ccc; padding:10px; border-radius:6px; min-height:200px; }
  .card { background:#fff; border:1px solid #ddd; padding:8px; border-radius:6px; margin-bottom:10px; }
  .card textarea { width:100%; min-height:120px; resize:vertical; }
</style>
</head>
<body class="p-4">

<h2>EPUB 英中章節編輯器</h2>

<div class="mb-3">
  <label class="form-label">上傳英文 EPUB</label>
  <input type="file" id="uploadEn" class="form-control mb-2" accept=".epub">
  <label class="form-label">上傳中文 EPUB</label>
  <input type="file" id="uploadZh" class="form-control mb-2" accept=".epub">
</div>

<div class="editor my-4">
  <div id="enCol" class="column"><h5>英文</h5></div>
  <div id="zhCol" class="column"><h5>中文</h5></div>
</div>

<div class="mt-3">
  <label class="form-label">起始序號</label>
  <input type="number" id="startIndex" class="form-control w-25 mb-2" value="0">
  <button class="btn btn-primary" id="generateBtn">產生檔案清單</button>
</div>

<script>
const backendURL = '/upload-image'; // 你的圖片上傳 API

// 建立章節卡片（每個章節一個 textarea）
function createCard(lang, htmlContent){
  const card = document.createElement("div");
  card.className = "card";
  card.innerHTML = `
    <textarea>${htmlContent}</textarea>
    <button class="btn btn-sm btn-danger mt-2 delete-btn" data-lang="${lang}">刪除</button>
  `;
  return card;
}

// 刪除卡片
document.addEventListener("click", e=>{
  if(e.target.classList.contains("delete-btn")){
    const card = e.target.closest(".card");
    if(card) card.remove();
  }
});

// 拖曳排序
new Sortable(document.getElementById("enCol"),{animation:150});
new Sortable(document.getElementById("zhCol"),{animation:150});

// 圖片上傳
async function uploadImage(file){
  const formData = new FormData();
  formData.append("image", file);
  const res = await fetch(backendURL,{method:"POST",body:formData});
  const data = await res.json();
  return data.url;
}

// 處理 HTML 中的圖片
async function processImages(html){
  const parser = new DOMParser();
  const doc = parser.parseFromString(html,"text/html");
  const imgs = doc.querySelectorAll("img");
  for(const img of imgs){
    if(img.src.startsWith("data:")) continue;
    try{
      const response = await fetch(img.src);
      const blob = await response.blob();
      const uploadedUrl = await uploadImage(blob);
      img.src = uploadedUrl;
    }catch(e){console.error("圖片上傳失敗:",e);}
  }
  return doc.body.innerHTML;
}

// 解析 EPUB，每個 spine item 當作一個章節卡片
async function parseEpub(file, targetCol, lang){
  const zip = await JSZip.loadAsync(file);
  const container = await zip.file("META-INF/container.xml").async("string");
  const parser = new DOMParser();
  const containerDoc = parser.parseFromString(container,"application/xml");
  const opfPath = containerDoc.querySelector("rootfile").getAttribute("full-path");
  const opfText = await zip.file(opfPath).async("string");
  const opfDoc = parser.parseFromString(opfText,"application/xml");

  const manifest = {};
  opfDoc.querySelectorAll("manifest > item").forEach(item=>{
    manifest[item.getAttribute("id")] = item.getAttribute("href");
  });

  const spineItems = [];
  opfDoc.querySelectorAll("spine > itemref").forEach(itemref=>{
    const idref = itemref.getAttribute("idref");
    spineItems.push(manifest[idref]);
  });

  const basePath = opfPath.substring(0,opfPath.lastIndexOf("/")+1);

  for(const href of spineItems){
    const filePath = basePath + href;
    if(zip.file(filePath)){
      let content = await zip.file(filePath).async("string");
      content = await processImages(content); // 圖片上傳後替換 src
      targetCol.appendChild(createCard(lang,content));
    }
  }
}

// EPUB 上傳事件
document.getElementById("uploadEn").addEventListener("change", async e=>{
  const file = e.target.files[0];
  if(file){
    const enCol = document.getElementById("enCol");
    enCol.innerHTML="<h5>英文</h5>";
    await parseEpub(file,enCol,"en");
  }
});

document.getElementById("uploadZh").addEventListener("change", async e=>{
  const file = e.target.files[0];
  if(file){
    const zhCol = document.getElementById("zhCol");
    zhCol.innerHTML="<h5>中文</h5>";
    await parseEpub(file,zhCol,"zh");
  }
});

// 產生檔案清單
document.getElementById("generateBtn").addEventListener("click",()=>{
  const startIndex = parseInt(document.getElementById("startIndex").value)||0;
  const enCards = [...document.querySelectorAll("#enCol .card textarea")];
  const zhCards = [...document.querySelectorAll("#zhCol .card textarea")];

  const maxCount = Math.max(enCards.length, zhCards.length)+startIndex;
  const padLength = maxCount>99?3:2;

  const enFiles = enCards.map((c,i)=>({
    name:`en-${String(i+startIndex).padStart(padLength,"0")}.txt`,
    content:c.value
  }));
  const zhFiles = zhCards.map((c,i)=>({
    name:`zh-${String(i+startIndex).padStart(padLength,"0")}.txt`,
    content:c.value
  }));

  console.log("English files:",enFiles);
  console.log("Chinese files:",zhFiles);
  alert("檔案清單已生成，請查看 console.log");
});
</script>
</body>
</html>
